# The Harrenhal Aftermath
agot_scenario_rr_ha_initialization_decision = {
	picture = {
		reference = "gfx/interface/illustrations/decisions/decision_realm.dds"
	}
	decision_group_type = major
	ai_check_interval = 120
	desc = agot_scenario_rr_ha_initialization_decision_desc

	is_shown = {
		this = character:Targaryen_3

		NOT = { # Can only do it once.
			is_target_in_global_variable_list = {
				name = unavailable_unique_decisions
				target = flag:agot_scenario_rr_ha_initialized_flag
			}
		}

		game_start_date >= 8277.10.1 # Defiance of Duskendale
		exists = title:e_the_iron_throne.holder
		title:e_the_iron_throne.holder = character:Targaryen_1

		is_ai = no
	}

	is_valid = {
		custom_tooltip = {
			text = agot_scenario_rr_ha_initialization_decision_requirement
			exists = title:e_the_iron_throne.holder
			title:e_the_iron_throne.holder = character:Targaryen_1
			is_ai = no
		}
	}

	effect = {
		character:Targaryen_3 = { save_scope_as = ha_initiator }
		hidden_effect = {
			add_to_global_variable_list = {
				name = unavailable_unique_decisions
				target = flag:agot_scenario_rr_ha_initialized_flag
			}
		}
		custom_tooltip = agot_scenario_rr_ha_initialization_decision_tooltip
		# TODO this sends events to powerful houses of the loyalist side and also to the LP on the enemy side and to neutral ones

		# Sends letters for a great war council
		# The powerful houses on Aerys side may decide to support Rhaegar in a possible war
		title:e_the_iron_throne.holder ?= {
			every_vassal_or_below = {
				limit = {
					OR = {
						primary_title.tier = tier_kingdom
						primary_title.tier = tier_duchy
					}
					NOT = { this = root }
				}
				trigger_event = { id = agot_scenario_rr_ha.0010 days = { 2 6 } }
			}
		}

		# To Rebels he proposes a peace, to take Lyanna for his wife and to scheme against the King # TODO
		scope:ha_initiator = { trigger_event = { id = agot_scenario_rr_ha.0011 days = { 20 30 } } }
	}


	ai_potential = {
		always = no
	}

	ai_will_do = {
		base = 100
	}
}

# Tell the king about the plot to abduct him
agot_scenario_rr_ha_tell_the_king_decision = {
	picture = {
		reference = "gfx/interface/illustrations/decisions/decision_realm.dds"
	}
	decision_group_type = major
	ai_check_interval = 120
	desc = agot_scenario_rr_ha_tell_the_king_decision_desc

	is_shown = {
		has_character_flag = agot_ha_knows_about_plot
		character:Targaryen_1 = {
			is_alive = yes
			has_title = title:e_the_iron_throne
		}
		character:Targaryen_3 = {
			is_alive = yes
		}
	}

	is_valid = {
		has_character_flag = agot_ha_knows_about_plot
	}

	effect = {
		custom_tooltip = agot_scenario_rr_ha_tell_the_king_decision_tooltip
		character:Targaryen_1 = { trigger_event = { id = agot_scenario_rr_ha.0021 days = { 4 8 } } }
	}

	ai_potential = {
		always = no
	}

	ai_will_do = {
		base = 100
	}
}

set_capital_kingslanding_decision = {
	picture = {
		reference = "gfx/interface/illustrations/decisions/decision_destiny_goal.dds"
	}

	desc = set_capital_kingslanding_decision_desc
	selection_tooltip = set_capital_kingslanding_decision_tooltip
	decision_group_type = major

	ai_check_interval = 12

	is_shown = {
		is_ruler = yes
		is_landed = yes
		has_title = title:e_the_iron_throne
		NOT = {
			capital_county = {
				this = title:c_kings_landing
			}
			title:b_hookmarket.title_province = {
				has_holding_type = ruin_holding
			}
		}
		OR = {
			title:c_kings_landing.holder = {
				any_liege_or_above = { this = root }
			}
			title:c_kings_landing.holder = { this = root }
		}
	}

	is_valid_showing_failures_only = {
		is_capable_adult = yes
		is_imprisoned = no
	}

	effect = {
		if = { #Usurp if not held personally.
			limit = {
				NOT = { title:c_kings_landing.holder = { this = root } }
			}
			title:c_kings_landing.holder = { save_scope_as = target_for_denunciation }
			create_title_and_vassal_change = {
				type = returned
				save_scope_as = change
				add_claim_on_loss = no
			}
			title:c_kings_landing = {
				change_title_holder = {
					holder = root
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change

		}
		if = { #Usurp if not held personally.
			limit = {
				exists = title:d_kings_landing.holder
				NOT = { title:d_kings_landing.holder = { this = root } }
			}
			title:d_kings_landing.holder = { save_scope_as = target_for_denunciation }
			create_title_and_vassal_change = {
				type = returned
				save_scope_as = change
				add_claim_on_loss = no
			}
			title:d_kings_landing = {
				change_title_holder = {
					holder = root
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change

		}
		set_realm_capital = title:c_kings_landing
		if = {
			limit = {
				exists = scope:target_for_denunciation
			}
			scope:target_for_denunciation = {
				trigger_event = {
					id = agot_events_generic.0002
				}
			}
		}
	}
	ai_potential = {
		primary_title.tier = tier_empire
		has_title = title:e_the_iron_throne
	}

	ai_will_do = { #Do it always, for coherence.
		base = 100
		modifier = {
			title:c_kings_landing.holder = {
				any_realm_county = {
					count < 2
					holder = title:c_kings_landing.holder
				}
			}
			factor = 0
		}
	}
}